# Build Architecture: Incremental Builds with PanaversityFS

## Overview

This repository uses **incremental builds** powered by PanaversityFS to handle 1000+ lesson files efficiently.

## Directory Structure

```
storage/
â”œâ”€â”€ book-source/
â”‚   â”œâ”€â”€ docs/              # âœï¸ AUTHORS WRITE HERE
â”‚   â”‚                      # - Markdown lesson files
â”‚   â”‚                      # - Local development content
â”‚   â”‚                      # - Source of truth (in git)
â”‚   â”‚
â”‚   â”œâ”€â”€ src/               # Docusaurus theme/components
â”‚   â”œâ”€â”€ static/            # Static assets
â”‚   â””â”€â”€ docusaurus.config.ts
â”‚
â”œâ”€â”€ build-source/          # ðŸ”¨ BUILD ARTIFACTS (gitignored)
â”‚   â”‚                      # - Hydrated content from PanaversityFS
â”‚   â”‚                      # - Generated by CI workflow
â”‚   â”‚                      # - Docusaurus reads from here when PanaversityFS enabled
â”‚   â”‚
â”œâ”€â”€ panaversity-fs/        # MCP server + build scripts
â”‚   â”œâ”€â”€ app/               # FastAPI server
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ ingest-book.py  # Uploads docs/ â†’ PanaversityFS
â”‚   â”‚   â””â”€â”€ hydrate-book.py # Downloads PanaversityFS â†’ build-source/
â”‚   â””â”€â”€ tests/
â”‚
â””â”€â”€ .panaversity/          # ðŸ“‹ MANIFEST CACHE (gitignored)
    â””â”€â”€ manifest.json      # Tracks last build state for delta detection
```

## Build Flow

### For Authors (No Change)

```
1. Edit files in apps/learn-app/docs/
2. git commit && git push
3. Open PR, get review, merge
4. Done! Site rebuilds automatically
```

### Behind The Scenes (Automatic)

```
Author pushes to apps/learn-app/docs/
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  .github/workflows/sync-content.yml â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚  1. Detect changed files (git diff) â”‚
    â”‚  2. Run ingest-book.py              â”‚
    â”‚  3. Upload ONLY changed files       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      PanaversityFS (R2 Storage)     â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚  - book-id: ai-native-dev           â”‚
    â”‚  - Delta detection via hashes       â”‚
    â”‚  - MCP tools for read/write         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  .github/workflows/deploy.yml       â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚  1. Restore manifest cache          â”‚
    â”‚  2. Run hydrate-book.py             â”‚
    â”‚  3. Download ONLY delta to          â”‚
    â”‚     build-source/                   â”‚
    â”‚  4. Fallback to docs/ if fails      â”‚
    â”‚  5. Docusaurus reads build-source/  â”‚
    â”‚  6. Build & deploy                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Benefits

| Aspect         | Before                    | After                     |
| -------------- | ------------------------- | ------------------------- |
| **Upload**     | All 1000+ files           | Only changed files (~3-5) |
| **Download**   | All 1000+ files (timeout) | Only delta (~500KB)       |
| **Build Time** | 8-10 minutes              | ~2 minutes                |
| **CI Cost**    | High                      | 50% lower                 |
| **Authors**    | Same workflow             | **No change**             |

## How It Works

### 1. Sync (Upload) - `ingest-book.py`

```bash
# What it does:
# - Scans apps/learn-app/docs/
# - Computes SHA256 hash for each file
# - Compares with PanaversityFS hashes
# - Uploads ONLY files where hash differs

python panaversity-fs/scripts/ingest-book.py \
  --book-id ai-native-dev \
  --source-dir book-source/docs \
  --verbose
```

**Example:**

- Author changes 3 files
- Sync uploads only those 3 files
- Takes ~5 seconds

### 2. Hydrate (Download) - `hydrate-book.py`

```bash
# What it does:
# - Loads manifest.json (tracks last build state)
# - Calls PanaversityFS plan_build tool (delta detection)
# - Downloads ONLY changed files to build-source/
# - Updates manifest for next build

python panaversity-fs/scripts/hydrate-book.py \
  --book-id ai-native-dev \
  --output-dir build-source \
  --manifest-file .panaversity/manifest.json \
  --verbose
```

**Example:**

- Last build had 1000 files
- 5 files changed since then
- Hydrate downloads only 5 files
- Takes ~10 seconds

### 3. Build - Docusaurus

```bash
# Docusaurus reads from:
# - build-source/ when PANAVERSITY_PLUGIN_ENABLED=true
# - docs/ when PANAVERSITY_PLUGIN_ENABLED=false (local dev)

npm run build
```

## Fallback Safety

If PanaversityFS fails:

```yaml
# In deploy.yml:
- name: Hydrate content
  continue-on-error: true # Don't fail build if hydration fails
  run: python hydrate-book.py ...

- name: Fallback to local docs
  if: failure()
  run: cp -r apps/learn-app/docs/* build-source/
```

**Result:** Builds never break, worst case uses slightly stale content.

## Local Development

### Option 1: Use Local Docs (Recommended)

```bash
cd book-source
PANAVERSITY_PLUGIN_ENABLED=false npm start

# Reads from apps/learn-app/docs/
# No PanaversityFS needed
```

### Option 2: Use PanaversityFS Locally

```bash
# Terminal 1: Run MCP server
cd panaversity-fs
uv run fastapi dev app/main.py

# Terminal 2: Hydrate content
python panaversity-fs/scripts/hydrate-book.py \
  --book-id ai-native-dev \
  --output-dir build-source

# Terminal 3: Start Docusaurus
cd book-source
PANAVERSITY_PLUGIN_ENABLED=true npm start
```

## Future: Repo Decoupling

**Current:** Monolith (authors and UI in same repo)

```
book-source/
â”œâ”€â”€ docs/       # Authors write here
â””â”€â”€ src/        # UI developers work here
```

**Future:** Separate repos (when ready)

```
Repo 1: book-ai-native-python/    # Content only
â”œâ”€â”€ Part-01/
â”œâ”€â”€ Part-02/
â””â”€â”€ .github/workflows/sync.yml    # Syncs to PanaversityFS

Repo 2: book-interface/            # UI only
â”œâ”€â”€ src/
â”œâ”€â”€ docusaurus.config.ts
â””â”€â”€ .github/workflows/deploy.yml   # Hydrates from PanaversityFS
```

**Migration path:**

- Phase 1: âœ… Working now (incremental builds in monolith)
- Phase 2: Enable sync workflow (dual-write)
- Phase 3: Create content repo (parallel operation)
- Phase 4: Cut-over (authors migrate)

## Monitoring

### Success Indicators

```bash
# In GitHub Actions logs:
âœ“ Sync: "Uploaded 3 files in 4.2s"
âœ“ Hydrate: "Downloaded 5 files (delta) in 8.1s"
âœ“ Build: "Build completed in 1m 34s"
```

### Cache Hit Rate

```
Manifest cache hit â†’ Incremental download (fast)
Manifest cache miss â†’ Full download (slower, but rare)

Target: >70% cache hit rate
```

## Troubleshooting

### Problem: 502 Timeout

**Old behavior:** Docusaurus plugin fetches all 1000+ files â†’ timeout

**Fixed:** Hydrate downloads incrementally, plugin uses pre-hydrated content

### Problem: Build using stale content

**Check:** Manifest cache might be stale

**Fix:**

```bash
# Trigger full rebuild via GitHub Actions UI
# Workflow dispatch â†’ deploy.yml â†’ Enable "full_rebuild"
```

### Problem: Sync not triggering

**Check:**

1. Did you push to `apps/learn-app/docs/`?
2. Is `PANAVERSITY_PLUGIN_ENABLED=true` in repo variables?
3. Check sync-content.yml logs

## Contributing

Authors: Keep working as usual in `apps/learn-app/docs/`

Developers:

- `book-source/src/` - UI components
- `panaversity-fs/` - MCP server and build scripts
- `.github/workflows/` - CI/CD pipelines

**Never edit:**

- `build-source/` (generated)
- `.panaversity/` (cache)

## Questions?

- **Incremental builds not working?** Check manifest cache in GitHub Actions
- **Want to disable PanaversityFS?** Set `PANAVERSITY_PLUGIN_ENABLED=false`
- **Need to force full sync?** Workflow dispatch â†’ sync-content.yml â†’ Enable "full_sync"
